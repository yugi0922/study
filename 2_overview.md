# 2. 新しいソリューション設計（29%）—話す原稿（画像差し込み位置つき）

## ねらい

このドメインでは、要件から**設計の型**を素早く引き出し、選択肢の良し悪しを**根拠つき**で説明できるかを見られます。最初に **IaC と デプロイ戦略** を決め、**可用性・性能・データ・実行基盤**を“要件→制約→失敗パターン”の順で詰めます。

---

## 1) 読み方の型（D2向け）

1. **非機能要件**：SLA（可用性/遅延）、RTO/RPO、スループット、地域、規制、運用工数、コスト上限を箇条書きにします。
2. **制約**：現行資産（DB/言語/プロトコル）、帯域・期間・人数、顧客/外部依存を分けます。
3. **失敗パターン**：リージョン障害、単一障害点、DNS/ヘルスチェック抜け、スケール限界、**TTL/リトライ/バックオフ忘れ**を想像します。
4. **標準で安全**な構成をまず当てにいきます（最小権限、暗号化、中央ログ、疎結合、ヘルスチェック）。
5. **タイブレーク**は数量条件（RTO/RPO、P99、TPS、転送料、SRE運用コスト）で決めます。

---

## 2) 先に決める：IaC と デプロイ戦略

### IaC（CloudFormation/CDK）

* **方針**：全スタックをコード化し、環境差分は**パラメータ＋Stage**で吸収します。StackSets/パイプラインで**マルチアカウント配布**にします。
* **ねらい**：再現性、レビュアブル（差分が見える）、自動ロールバック、監査のしやすさです。

![IaC配布ライン（CDK/CFn→Pipeline→StackSets→複数アカウント/リージョン）](./images/sap2_01_iac.png)

### デプロイ戦略（Blue/Green / Canary / 自動ロールバック）

* **Blue/Green**：**ゼロダウン**が最優先で、切替・戻しを明確にしたいときに使います（ALB/CodeDeploy/Route 53で実現します）。
* **Canary**：影響を**段階的**に広げて計測しながら切替えたいときに使います（%トラフィック／時間ベース）。
* **自動ロールバック**：**ヘルスシグナル**（4xx/5xx、Latency、SLO逸脱、合成監視）で即戻します。
* **避けたい誤り**：メトリクスと閾値が曖昧／**ヘルスチェック未連動**／DBスキーマの前方互換性を無視。

![デプロイ決定表（Blue/Green/Canaryの選び分け＋ロールバックのトリガ）](./images/sap2_02_deploy.png)

---

## 3) 可用性：マルチAZ/マルチリージョン＋Route 53

* **マルチAZ**：まずは**前提**です。単一AZ前提の案は基本的に切ります。
* **マルチリージョン**：RTO/RPOと**データ一貫性**の要求で選びます。Active–ActiveはRTO最短だが整合性・コストが上がります。
* **Route 53**：

  * **フェイルオーバ**（Primary/Secondary）
  * **レイテンシ**（利用者に最も近い健全エンドポイント）
  * **地理**（Geo/Geoproximity：法規・データ所在地対策）
  * **必ずヘルスチェック**を連動させます（未設定は頻出の罠）。

**選び分けの目安**

| 要件                 | 推奨                           | 注意点                  |
| ------------------ | ---------------------------- | -------------------- |
| RTO ≤ 1分 / グローバル配信 | **Active–Active + レイテンシ**    | 書込分散は整合性戦略（最終/強整合）必須 |
| RTO 5–15分 / コスト抑制  | **Active–Passive + フェイルオーバ** | データレプリカの遅延とTTL調整     |
| 地域規制／データ所在         | **地理ルーティング**                 | “越境禁止”の設計根拠を明確に      |

![グローバル可用性（Active–Active/Passive、Route53ポリシー＋ヘルスチェック）](./images/sap2_03_ha.png)

---

## 4) 性能：キャッシュと非同期化（バックプレッシャを設計に）

### キャッシュ

* **エッジ**：**CloudFront**（静的/動的キャッシュ、近接、圧縮、OACでS3直保護）。
* **アプリ内**：**ElastiCache**（読み多・ランキング・セッションの外出し）。
* **TTLの設計**：**短すぎる＝無効化、長すぎる＝鮮度喪失**。**キャッシュキー**を明示し、**無効化の手段**（イベント/パス）を持ちます。

### 非同期化

* **SQS**（“仕事”のキュー、リトライ・DLQ、アイドポテンシ）
* **SNS**（Pub/Subの**扇型**配布）
* **EventBridge**（疎結合な**イベントルータ**、スキーマ進化に強い）
* **Kinesis / MSK**（**順序・高スループット**のストリーム処理、状態ful集計）

**リトライ設計の原則**：**指数バックオフ＋ジッタ**、**アイドポテンシ**（重複抑止キー）、**DLQ/ポイズンメッセージ**の隔離、**タイムアウト**は上流から下流へ短く。

![性能チューニング（Edge/アプリ内キャッシュ、キュー、ストリーム、DLQ、バックオフ/ジッタ）](./images/sap2_04_perf.png)

---

## 5) データ／ストレージ選定（役割で分ける）

* **S3**：データレイク、静的配信、バックアップ。**クラス選択**（Standard/IA/One Zone/Glacier系）と**ライフサイクル**を前提にします。
* **EFS**：**POSIX**共有、横にスケール、スループット/IOモードの選択。
* **FSx**：**特定ワークロード向け**（Lustre/HDFS系、Windows、NetApp ONTAPなど）。
* **ブロック（EBS）**：低遅延・IOPS確保。**AZローカル**でフェイル時の設計注意。

**パターン例**

| 状況                | 第一候補                | 理由               |
| ----------------- | ------------------- | ---------------- |
| 静的Web/アーカイブ       | **S3 + CloudFront** | コスト効率・グローバル配信    |
| ML/解析の一時高IO       | **FSx for Lustre**  | 高IO/一時接続でS3と相性   |
| 共有POSIX + サーバレス混在 | **EFS**             | 複数ワークロードから同時に使える |
| データベースの永続         | **EBS**             | 低遅延・IOPSチューニング   |

![ストレージ選定の決定木（S3/EFS/FSx/EBSの役割分担）](./images/sap2_05_storage.png)

---

## 6) データベース選定：Aurora/RDS vs DynamoDB

**“アクセスパターン”を先に固定**してから選びます。

| 観点     | **Aurora/RDS**                   | **DynamoDB**                    |
| ------ | -------------------------------- | ------------------------------- |
| ワークロード | リレーショナル、複雑JOIN、トランザクション          | キーアクセス、超スケール、可用性優先              |
| 一貫性    | 強整合/リードレプリカ                      | 最終/強整合選択、**パーティション設計が鍵**        |
| スケール   | 垂直＋水平（リードレプリカ/Aurora Serverless） | 水平スケール（パーティション）                 |
| 運用     | スキーマ進化、SQLツール資産                  | スキーマレス、WCU/RCU、**ホットパーティション注意** |
| 代表落とし穴 | 書込スケール限界、ロック争い                   | キー設計不備、スキャン過多、GSI運用             |

**決め手の一言**

* **複雑な結合/トランザクション**が主なら **Aurora/RDS** です。
* **アクセスパターンが決まっている**高スループット/低レイテンシなら **DynamoDB** です（**パーティションキー設計**が合否を分けます）。
* グローバル書込が要件なら **DynamoDB Global Tables** を候補にします。

![DB選定マトリクス（Aurora/RDS vs DynamoDB：パターン別）](./images/sap2_06_db.png)

---

## 7) 実行基盤：Lambda / ECS / EKS の選び分け

* **Lambda**：イベント駆動、バースト、短時間処理、運用最小化。**コールドスタート**と**実行時間上限**を確認します。
* **ECS（Fargate/Ec2）**：**コンテナ運用の軽さ**を優先。ジョブ/常駐/HTTP APIに広く適用。
* **EKS**：**Kubernetes資産**や高度な**Podレベル制御**が必要なとき。運用境界が広がる点を承知で選びます。
* **App Runner**：HTTP向けに**最小オペレーション**を取りたいときの選択肢。

**選定軸**：**責務の境界**（どこまで運用するか）／**チームスキル**／**可観測性**／**レイテンシ/起動特性**／**コスト**。

![実行基盤の選定軸（Lambda/ECS/EKS/App Runnerの位置づけ）](./images/sap2_07_runtime.png)

---

## 8) 失敗しやすいポイント（頻出の罠）

* **TTL/リトライ/指数バックオフ＋ジッタ**の入れ忘れ。
* **Route 53 ヘルスチェック未設定**（ポリシーだけ設定して切り替わらない）。
* **Aurora と DynamoDB の選定理由が曖昧**（アクセスパターンで語れていない）。
* **DBスキーマの前方互換性を無視**して Blue/Green/Canary が破綻。
* **キャッシュ無効化の手段がない**、**キー設計が曖昧**。
* **アイドポテンシがない**／**DLQ未設定**でリトライ地獄。

---

## 9) 代表ミニケース（正解の筋と罠）

### A. RTO=1分、**グローバル**、**高スループット書き込み**

* **正解の筋**：**Active–Active**（各リージョンにAPI/DB）、**Route 53レイテンシ**＋**ヘルスチェック**、**非同期複製**（グローバルテーブル／ストリーム＋整合戦略）、**Blue/Green**。
* **罠**：Active–PassiveでRTOが足りない／整合性を説明できない。

### B. 動的Webで**読みスパイク**、コストは厳しめ

* **正解の筋**：**CloudFront**（動的キャッシュ）＋**ElastiCache**、**SQS/非同期**でピーク吸収、**AutoScaling**。
* **罠**：キャッシュキー/TTL未設計でミスヒット／NAT経由で転送料が膨張。

### C. センサーデータの**順序維持＋高スループット集計**

* **正解の筋**：**Kinesis/MSK**で取り込み、**Lambda/ECS**で集計、**DynamoDB/Timestream**へ。
* **罠**：SQSで順序要件を満たせず再設計／パーティション設計不足。

### D. B2B連携で**相手システム都合**に引っ張られる

* **正解の筋**：**EventBridge**で疎結合、**リトライ＋DLQ＋アイドポテンシ**、**Blue/Green**で相手変更に追従。
* **罠**：同期前提でカップリングが高止まり。

---

## 10) 直前チェックリスト（□で確認）

* [ ] IaCで**再現性**と**ロールバック**を担保できていますか。
* [ ] デプロイの\*\*選び分け（Blue/Green/Canary）\*\*を一言で説明できますか。
* [ ] Route 53の**ポリシー＋ヘルスチェック**をセットで語れますか。
* [ ] キャッシュの**TTL/キー/無効化**と、**非同期のリトライ/バックオフ/ジッタ/DLQ**を設計しましたか。
* [ ] **S3/EFS/FSx/EBS**の役割分担を言語化できますか。
* [ ] **Aurora/RDS vs DynamoDB**を**アクセスパターン**で選べますか。
* [ ] 実行基盤（Lambda/ECS/EKS）の**運用境界**と**チームスキル**を踏まえていますか。
* [ ] **RTO/RPO**・P99・転送料・運用工数の**数量根拠**でタイブレークできますか。

---

## 画像差し込み位置一覧（ファイル名は任意に置き換えてください）

1. **IaC配布ライン**：`![IaC配布ライン](./images/sap2_01_iac.png)`
2. **デプロイ決定表**：`![デプロイ決定表](./images/sap2_02_deploy.png)`
3. **グローバル可用性**：`![グローバル可用性](./images/sap2_03_ha.png)`
4. **性能チューニング図**（キャッシュ/非同期/バックオフ）：`![性能設計](./images/sap2_04_perf.png)`
5. **ストレージ決定木**（S3/EFS/FSx/EBS）：`![ストレージ選定](./images/sap2_05_storage.png)`
6. **DB選定マトリクス**（Aurora/RDS vs DynamoDB）：`![DB選定](./images/sap2_06_db.png)`
7. **実行基盤の選定軸**（Lambda/ECS/EKS/App Runner）：`![実行基盤](./images/sap2_07_runtime.png)`

---

以上をそのままマークダウンで貼り込んでいただければ、**試験の“選び分け”理由**と**落とし穴**までを一気に説明できます。
